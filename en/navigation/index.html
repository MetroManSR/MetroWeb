<!DOCTYPE html>
<html>
<head>
    <title>Smart City Terrain Map (2x2km)</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #121212;
            color: #e0e0e0;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        #map-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            display: inline-block;
        }
        #map {
            font-size: 8px;
            line-height: 8px;
            letter-spacing: 1px;
            white-space: pre;
            overflow: auto;
            max-height: 500px;
            padding: 10px;
            background: #222;
            border-radius: 4px;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        button {
            background: #333;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
        }
        button:hover {
            background: #444;
        }
        button:active {
            background: #555;
        }
        .nav-btn {
            font-size: 16px;
            padding: 10px;
        }
        #coords, #location-info {
            font-family: monospace;
            background: #252525;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: inline-block;
        }
        #status {
            color: #aaa;
            font-size: 14px;
            margin-top: 10px;
        }
        .coord-input {
            margin: 10px 0;
        }
        .coord-input input {
            background: #252525;
            color: white;
            border: 1px solid #333;
            padding: 8px;
            border-radius: 4px;
            width: 120px;
            margin: 0 5px;
        }
        .coord-input button {
            margin-left: 10px;
        }
        /* Terrain Colors */
        .water { color: #5af; }
        .ground { color: #ba9; }
        .building { color: #f88; }
        .road { color: #fd5; }
        .park { color: #5c5; }
        .lidar { color: #8cf; }
        .unknown { color: #777; }
    </style>
</head>
<body>
    <h1>2x2km City Terrain Map</h1>
    
    <div id="coords">Latitude: 40.7128, Longitude: -74.0060</div>
    <div id="location-info">New York, US | Using: Global Dataset</div>
    
    <div class="coord-input">
        <input type="text" id="latInput" placeholder="Latitude" value="40.7128">
        <input type="text" id="lonInput" placeholder="Longitude" value="-74.0060">
        <button id="goToCoords">Go</button>
    </div>
    
    <div class="controls">
        <div></div>
        <button class="nav-btn" id="moveNorth">↑</button>
        <div></div>
        <button class="nav-btn" id="moveWest">←</button>
        <button id="recenter">◎</button>
        <button class="nav-btn" id="moveEast">→</button>
        <div></div>
        <button class="nav-btn" id="moveSouth">↓</button>
        <div></div>
    </div>
    
    <div id="map-container">
        <div id="map" class="loading">Initializing terrain engine...</div>
    </div>
    
    <div id="status">Detecting elevation source...</div>

    <script>
        // ================ CONFIGURATION ================
        const MAP_SIZE = 40; // 40x40 characters
        const CELL_SIZE_METERS = 50; // 50m per character (2000m/40=50m)
        const MOVE_DISTANCE = 0.0045; // Degrees per movement (~500m)
        const MAX_DISTANCE = 0.009; // ~1km from center (2x2km total)
        
        // ================ STATE MANAGEMENT ================
        let currentLat = 40.7128; // New York
        let currentLon = -74.0060;
        let isLoading = false;
        let currentDataSource = { name: "Global Dataset", resolution: 90 };
        let elevationCache = new Map();

        // ================ ELEVATION DATASETS ================
        const elevationDatasets = [
            // Global dataset using AWS Terrain Tiles
            {
                name: "Global Dataset",
                resolution: 90,
                priority: 0,
                bounds: {
                    minX: -180.0,
                    maxX: 180.0,
                    minZ: -85,
                    maxZ: 85
                },
                getElevation: async function(lat, lon) {
                    const zoom = 10; // Using zoom level 10 as requested
                    
                    // Convert lat/lon to tile coordinates
                    const latRad = lat * Math.PI / 180;
                    const n = Math.pow(2, zoom);
                    const tileX = Math.floor((lon + 180) / 360 * n);
                    const tileY = Math.floor((1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n);
                    
                    const cacheKey = `tile-${zoom}-${tileX}-${tileY}`;
                    
                    try {
                        // Check if we have this tile cached
                        if (!elevationCache.has(cacheKey)) {
                            const response = await fetch(`https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${zoom}/${tileX}/${tileY}.png`);
                            const blob = await response.blob();
                            const img = await createImageBitmap(blob);
                            
                            // Create canvas to read pixel data
                            const canvas = document.createElement('canvas');
                            canvas.width = 256;
                            canvas.height = 256;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            // Store the image data in cache
                            elevationCache.set(cacheKey, canvas);
                        }
                        
                        const canvas = elevationCache.get(cacheKey);
                        const ctx = canvas.getContext('2d');
                        
                        // Calculate pixel position within tile
                        const pixelX = Math.floor(((lon + 180) / 360 * n - tileX) * 256);
                        const pixelY = Math.floor(((1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n - tileY) * 256);
                        
                        // Get pixel data
                        const pixelData = ctx.getImageData(pixelX, pixelY, 1, 1).data;
                        
                        // Terrarium format: (R * 256 + G + B / 256) - 32768
                        const elevation = (pixelData[0] * 256 + pixelData[1] + pixelData[2] / 256) - 32768;
                        return elevation;
                    } catch (e) {
                        console.error("Error fetching elevation tile:", e);
                        return 0; // Fallback to 0 elevation
                    }
                }
            }
        ];

        // ================ ELEVATION FUNCTIONS ================
        async function getElevation(lat, lon) {
            const cacheKey = `${lat.toFixed(5)},${lon.toFixed(5)}`;
            
            if (elevationCache.has(cacheKey)) {
                return elevationCache.get(cacheKey);
            }
            
            // Use the global dataset
            const dataset = elevationDatasets[0];
            currentDataSource = {
                name: dataset.name,
                resolution: dataset.resolution
            };
            
            try {
                const elevation = await dataset.getElevation(lat, lon);
                elevationCache.set(cacheKey, elevation);
                return elevation;
            } catch (e) {
                console.error("Error getting elevation:", e);
                return 0; // Fallback
            }
        }

        // ================ TERRAIN GENERATION ================
        async function generateMap() {
            if (isLoading) return;
            isLoading = true;
            
            updateStatus("Loading elevation data...");
            updateCoords();
            
            document.getElementById('map').className = 'loading';
            document.getElementById('map').textContent = 'Rendering terrain...';
            
            try {
                const grid = await generateElevationGrid();
                renderMap(grid);
                updateStatus(`Ready | ${currentDataSource.name} | 2x2km area`);
                updateLocationInfo();
            } catch (error) {
                console.error("Map generation failed:", error);
                document.getElementById('map').textContent = "Error: Could not load terrain data";
                updateStatus("Failed to generate map");
            } finally {
                isLoading = false;
            }
        }

        async function generateElevationGrid() {
            const grid = [];
            const metersPerDegreeLat = 111320;
            const metersPerDegreeLon = 111320 * Math.cos(currentLat * Math.PI/180);
            
            // Calculate boundaries to stay within 2x2km
            const centerLat = currentLat;
            const centerLon = currentLon;
            
            for (let y = 0; y < MAP_SIZE; y++) {
                grid[y] = [];
                for (let x = 0; x < MAP_SIZE; x++) {
                    const lat = centerLat + (y - MAP_SIZE/2) * (CELL_SIZE_METERS / metersPerDegreeLat);
                    const lon = centerLon + (x - MAP_SIZE/2) * (CELL_SIZE_METERS / metersPerDegreeLon);
                    
                    // Check if we're within 1km of center (2x2km total area)
                    const distLat = Math.abs(lat - centerLat) * metersPerDegreeLat;
                    const distLon = Math.abs(lon - centerLon) * metersPerDegreeLon;
                    
                    if (distLat > 1000 || distLon > 1000) {
                        grid[y][x] = 0; // Out of bounds
                        continue;
                    }
                    
                    grid[y][x] = await getElevation(lat, lon);
                    
                    // Throttle requests to avoid overloading
                    if ((y * MAP_SIZE + x) % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                }
            }
            
            return grid;
        }

        function renderMap(grid) {
            let mapOutput = '';
            const centerElev = grid[Math.floor(MAP_SIZE/2)][Math.floor(MAP_SIZE/2)];
            
            for (let y = 0; y < MAP_SIZE; y++) {
                for (let x = 0; x < MAP_SIZE; x++) {
                    const elev = grid[y][x];
                    let char, cls;
                    
                    // Skip rendering if out of bounds
                    if (elev === 0) {
                        mapOutput += ' ';
                        continue;
                    }
                    
                    // Relative elevation to center
                    const relElev = elev - centerElev;
                    
                    if (elev < 10) {
                        char = '≈'; cls = 'water';
                    } else if (Math.abs(relElev) < 5) {
                        char = '·'; cls = 'road';
                    } else if (relElev > 20) {
                        char = '█'; cls = 'building';
                    } else if (relElev < -5) {
                        char = '≈'; cls = 'water';
                    } else {
                        char = '·'; 
                        cls = 'ground';
                    }
                    
                    mapOutput += `<span class="${cls}">${char}</span>`;
                }
                mapOutput += '\n';
            }
            
            document.getElementById('map').innerHTML = mapOutput;
            document.getElementById('map').className = '';
        }

        // ================ UTILITIES ================
        function moveMap(dLat, dLon) {
            currentLat = +(currentLat + dLat).toFixed(6);
            currentLon = +(currentLon + dLon).toFixed(6);
            elevationCache.clear();
            generateMap();
        }

        function updateCoords() {
            document.getElementById('coords').textContent = 
                `Latitude: ${currentLat.toFixed(4)}, Longitude: ${currentLon.toFixed(4)}`;
        }

        async function updateLocationInfo() {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLat}&lon=${currentLon}&zoom=16`);
                const data = await response.json();
                const city = data.address?.city || data.address?.town || data.address?.village || "Unknown";
                const country = data.address?.country || "Unknown";
                
                document.getElementById('location-info').textContent = 
                    `${city}, ${country} | Using: ${currentDataSource.name}`;
            } catch (e) {
                document.getElementById('location-info').textContent = 
                    `Using: ${currentDataSource.name}`;
            }
        }

        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        function recenter() {
            currentLat = 40.7128;
            currentLon = -74.0060;
            elevationCache.clear();
            generateMap();
        }

        function goToCoordinates() {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lon = parseFloat(document.getElementById('lonInput').value);
            
            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                alert("Please enter valid coordinates\nLatitude: -90 to 90\nLongitude: -180 to 180");
                return;
            }
            
            currentLat = lat;
            currentLon = lon;
            elevationCache.clear();
            generateMap();
        }

        // ================ INITIALIZATION ================
        document.getElementById('moveNorth').addEventListener('click', () => moveMap(-MOVE_DISTANCE, 0));
        document.getElementById('moveSouth').addEventListener('click', () => moveMap(MOVE_DISTANCE, 0));
        document.getElementById('moveWest').addEventListener('click', () => moveMap(0, -MOVE_DISTANCE));
        document.getElementById('moveEast').addEventListener('click', () => moveMap(0, MOVE_DISTANCE));
        document.getElementById('recenter').addEventListener('click', recenter);
        document.getElementById('goToCoords').addEventListener('click', goToCoordinates);

        // Start loading
        generateMap();
    </script>
</body>
</html>
